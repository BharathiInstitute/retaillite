rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Helper function to check if user is a super admin
    function isAdmin() {
      return request.auth != null && 
        request.auth.token.email in [
          'kehsaram001@gmail.com',
          'admin@retaillite.com',
          'bharathiinstitute1@gmail.com',
          'bharahiinstitute1@gmail.com',
          'shivamsingh8556@gmail.com',
          'admin@lite.app',
          'kehsihba@gmail.com'
        ];
    }
    
    // Helper function to validate required string field
    function hasString(field) {
      return field is string && field.size() > 0;
    }
    
    // Helper function to validate positive number
    function isPositive(value) {
      return value is number && value >= 0;
    }
    
    // Helper: limit document size (prevent abuse)
    function isReasonableSize() {
      return request.resource.size() < 500000; // 500KB max per document
    }
    
    // ===================
    // USER DOCUMENTS
    // ===================
    match /users/{userId} {
      // Users can read their own document, admins can read all
      allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
      
      // Allow both create and update (for upsert operations)
      allow write: if isAuthenticated() && isOwner(userId) && isReasonableSize();
      
      // Admins can update user subscription/limits
      allow update: if isAdmin();
      
      // Don't allow deletion
      allow delete: if false;
      
      // ===================
      // SETTINGS (sub-collection for user preferences sync)
      // ===================
      match /settings/{settingId} {
        allow read: if isAuthenticated() && isOwner(userId);
        allow write: if isAuthenticated() && isOwner(userId) && isReasonableSize();
      }
      
      // ===================
      // PRODUCTS (sub-collection)
      // ===================
      match /products/{productId} {
        allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
        allow create, update: if isAuthenticated() && isOwner(userId)
          && hasString(request.resource.data.name)
          && request.resource.data.name.size() <= 200
          && isPositive(request.resource.data.price)
          && request.resource.data.price <= 9999999
          && isReasonableSize();
        allow delete: if isAuthenticated() && isOwner(userId);
      }
      
      // ===================
      // BILLS (sub-collection)
      // ===================
      match /bills/{billId} {
        allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
        // Allow create for new bills with field validation
        allow create: if isAuthenticated() && isOwner(userId)
          && request.resource.data.total is number
          && request.resource.data.total >= 0
          && request.resource.data.total <= 99999999
          && request.resource.data.items is list
          && request.resource.data.items.size() > 0
          && request.resource.data.items.size() <= 500
          && isReasonableSize();
        // Bills are immutable - no update
        allow update: if false;
        // Owner can delete for data retention/cleanup
        allow delete: if isAuthenticated() && isOwner(userId);
      }
      
      // ===================
      // CUSTOMERS (sub-collection)
      // ===================
      match /customers/{customerId} {
        allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
        allow create, update: if isAuthenticated() && isOwner(userId)
          && hasString(request.resource.data.name)
          && request.resource.data.name.size() <= 200
          && isReasonableSize();
        allow delete: if isAuthenticated() && isOwner(userId);
        
        // ===================
        // TRANSACTIONS (nested sub-collection under customers - legacy)
        // ===================
        match /transactions/{transactionId} {
          allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
          allow create: if isAuthenticated() && isOwner(userId)
            && request.resource.data.amount is number
            && request.resource.data.amount > 0
            && request.resource.data.amount <= 99999999
            && isReasonableSize();
          allow update: if false;
          // Owner can delete for data retention/cleanup
          allow delete: if isAuthenticated() && isOwner(userId);
        }
      }
      
      // ===================
      // EXPENSES (sub-collection)
      // ===================
      match /expenses/{expenseId} {
        allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
        allow create, update: if isAuthenticated() && isOwner(userId)
          && request.resource.data.amount is number
          && request.resource.data.amount > 0
          && request.resource.data.amount <= 99999999
          && isReasonableSize();
        allow delete: if isAuthenticated() && isOwner(userId);
      }
      
      // ===================
      // TRANSACTIONS (direct sub-collection under user)
      // ===================
      match /transactions/{transactionId} {
        allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
        allow create: if isAuthenticated() && isOwner(userId)
          && request.resource.data.amount is number
          && request.resource.data.amount > 0
          && request.resource.data.amount <= 99999999
          && isReasonableSize();
        // Transactions are immutable - no update
        allow update: if false;
        // Owner can delete for data retention/cleanup
        allow delete: if isAuthenticated() && isOwner(userId);
      }
      
      // ===================
      // NOTIFICATIONS (sub-collection)
      // Written by Cloud Functions or Admin panel, read/updated by client
      // ===================
      match /notifications/{notificationId} {
        allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
        allow update: if isAuthenticated() && (isOwner(userId) || isAdmin());
        allow delete: if isAuthenticated() && (isOwner(userId) || isAdmin());
        // Admin can create notifications from admin panel, Cloud Functions use Admin SDK
        allow create: if isAdmin();
      }
      
      // ===================
      // ATTENDANCE (sub-collection)
      // ===================
      match /attendance/{attendanceId} {
        allow read: if isAuthenticated() && isOwner(userId);
        allow create, update: if isAuthenticated() && isOwner(userId)
          && isReasonableSize();
        allow delete: if isAuthenticated() && isOwner(userId);
      }
      
      // ===================
      // COUNTERS (sub-collection for atomic bill numbering etc.)
      // ===================
      match /counters/{counterId} {
        allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
        allow write: if isAuthenticated() && isOwner(userId) && isReasonableSize();
      }
    }
    
    // ===================
    // ADMIN-ONLY COLLECTIONS
    // ===================
    match /_admin/{document=**} {
      allow read, write: if isAdmin();
    }
    
    // Legacy admin path
    match /admin/{document=**} {
      allow read, write: if isAdmin();
    }
    
    // ===================
    // APP CONFIG (super admin management)
    // ===================
    match /app_config/{configId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // ===================
    // APP HEALTH & PERFORMANCE
    // Rate-limit: only allow creating docs, not spamming
    // ===================
    match /app_health/{docId} {
      allow create: if isAuthenticated() && isReasonableSize();
      allow read: if isAdmin();
      allow update, delete: if isAdmin();
    }
    
    match /screen_performance/{docId} {
      allow create: if isAuthenticated() && isReasonableSize();
      allow read: if isAdmin();
      allow update, delete: if isAdmin();
    }
    
    match /error_logs/{docId} {
      allow create: if isAuthenticated() && isReasonableSize();
      allow read: if isAdmin();
      allow update, delete: if isAdmin();
    }
    
    // ===================
    // GLOBAL NOTIFICATIONS (system-wide alerts)
    // Created by Cloud Functions or Admin panel, read by admins
    // ===================
    match /notifications/{notifId} {
      allow read: if isAdmin();
      // Admin can create/update from admin panel, Cloud Functions use Admin SDK
      allow write: if isAdmin();
    }
    
    // ===================
    // PAYMENT LINKS (created by Cloud Functions)
    // ===================
    match /payment_links/{linkId} {
      allow read: if isAdmin();
      // Cloud Functions create and update these via Admin SDK
      allow write: if false;
    }
    
    // ===================
    // ADMINS COLLECTION (used by Cloud Functions only)
    // ===================
    match /admins/{adminId} {
      allow read, write: if isAdmin();
    }
    
    // ===================
    // REGISTRATION OTPs (Cloud Functions only — no client access)
    // ===================
    match /registration_otps/{otpId} {
      allow read, write: if false;
    }
    
    // ===================
    // USER USAGE TRACKING (per-user backend cost tracking)
    // ===================
    match /user_usage/{userId} {
      // Users can read/write their own usage doc
      allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
      allow write: if isAuthenticated() && isOwner(userId) && isReasonableSize();
      // Admins can update (e.g., reset monthly usage)
      allow update: if isAdmin();
    }
    
    // ===================
    // PAYMENT REQUESTS (for payment links)
    // ===================
    match /payment_requests/{requestId} {
      allow create: if isAuthenticated() && isReasonableSize();
      allow read: if isAuthenticated() && 
        (resource.data.createdBy == request.auth.uid || isAdmin());
      allow update: if isAdmin();
      allow delete: if false;
    }
    
    // ===================
    // DESKTOP AUTH SESSIONS (for web-based desktop login flow)
    // These must be accessible BEFORE authentication (unauthenticated users)
    // Security: limited fields, small size, sessions are short-lived
    // ===================
    match /desktop_auth_sessions/{sessionId} {
      // Allow anyone to create a pending session (desktop app creates before auth)
      allow create: if request.resource.data.keys().hasOnly(['status', 'createdAt', 'expiresAt'])
        && request.resource.data.status == 'pending'
        && request.resource.size() < 1000;
      
      // Allow reading session to poll for auth token
      // Note: sessionId acts as a secret — only the creator knows it
      allow read: if true;
      
      // Only authenticated users can update (web login page sets the token)
      // Cloud Functions also update via Admin SDK (bypasses rules)
      allow update: if isAuthenticated() && request.resource.size() < 5000;
      
      // Only authenticated users or admins can delete sessions
      allow delete: if isAuthenticated();
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
