rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Helper function to check if user is a super admin
    function isAdmin() {
      return request.auth != null && 
        request.auth.token.email in [
          'kehsaram001@gmail.com',
          'admin@retaillite.com',
          'bharathiinstitute1@gmail.com'
        ];
    }
    
    // Helper function to validate required string field
    function hasString(field) {
      return field is string && field.size() > 0;
    }
    
    // Helper function to validate positive number
    function isPositive(value) {
      return value is number && value >= 0;
    }
    
    // ===================
    // USER DOCUMENTS
    // ===================
    match /users/{userId} {
      // Users can read their own document, admins can read all
      allow read: if isAuthenticated() && (isOwner(userId) || isAdmin());
      
      // Allow both create and update (for upsert operations)
      // This fixes the "No document to update" error
      allow write: if isAuthenticated() && isOwner(userId);
      
      // Admins can update user subscription/limits
      allow update: if isAdmin();
      
      // Don't allow deletion
      allow delete: if false;
      
      // ===================
      // PRODUCTS (sub-collection)
      // ===================
      match /products/{productId} {
        allow read: if isAuthenticated() && isOwner(userId);
        allow write: if isAuthenticated() && isOwner(userId);
        allow delete: if isAuthenticated() && isOwner(userId);
      }
      
      // ===================
      // BILLS (sub-collection)
      // ===================
      match /bills/{billId} {
        allow read: if isAuthenticated() && isOwner(userId);
        // Allow create for new bills
        allow create: if isAuthenticated() && isOwner(userId);
        // Bills are immutable - no update or delete
        allow update: if false;
        allow delete: if false;
      }
      
      // ===================
      // CUSTOMERS (sub-collection)
      // ===================
      match /customers/{customerId} {
        allow read: if isAuthenticated() && isOwner(userId);
        // Allow create and update for customers
        allow write: if isAuthenticated() && isOwner(userId);
        allow delete: if isAuthenticated() && isOwner(userId);
        
        // ===================
        // TRANSACTIONS (nested sub-collection under customers - legacy)
        // ===================
        match /transactions/{transactionId} {
          allow read: if isAuthenticated() && isOwner(userId);
          allow create: if isAuthenticated() && isOwner(userId);
          allow update: if false;
          allow delete: if false;
        }
      }
      
      // ===================
      // TRANSACTIONS (direct sub-collection under user)
      // This is where the app stores transactions
      // ===================
      match /transactions/{transactionId} {
        allow read: if isAuthenticated() && isOwner(userId);
        // Allow create for new transactions (payments, credits)
        allow create: if isAuthenticated() && isOwner(userId);
        // Transactions are immutable - no update or delete
        allow update: if false;
        allow delete: if false;
      }
    }
    
    // ===================
    // ADMIN-ONLY COLLECTIONS
    // ===================
    match /_admin/{document=**} {
      // Super admins can read/write admin data
      allow read, write: if isAdmin();
    }
    
    // Legacy admin path
    match /admin/{document=**} {
      allow read, write: if isAdmin();
    }
    
    // ===================
    // APP HEALTH & PERFORMANCE
    // ===================
    match /app_health/{docId} {
      // Any authenticated user can create health metrics
      allow create: if isAuthenticated();
      // Only admin can read all metrics
      allow read: if isAdmin();
      // No updates or deletes for data integrity
      allow update, delete: if isAdmin();
    }
    
    match /screen_performance/{docId} {
      allow create: if isAuthenticated();
      allow read: if isAdmin();
      allow update, delete: if isAdmin();
    }
    
    match /error_logs/{docId} {
      allow create: if isAuthenticated();
      allow read: if isAdmin();
      allow update, delete: if isAdmin();
    }
    
    // ===================
    // PAYMENT REQUESTS (for payment links)
    // ===================
    match /payment_requests/{requestId} {
      // Anyone authenticated can create payment requests
      allow create: if isAuthenticated();
      // Only the creator or admin can read
      allow read: if isAuthenticated();
      // Only admin can update (for status changes from webhooks)
      allow update: if isAdmin();
      allow delete: if false;
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
